var l=Object.defineProperty;var p=(u,e,t)=>e in u?l(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var n=(u,e,t)=>p(u,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();function d(u,e){return e==="admin"?u==="admin":e==="user"?u==="user"||u==="admin":!0}class a{constructor(e,t,r){n(this,"_name","name");n(this,"_parent");n(this,"_children");n(this,"_files");n(this,"_accessAuthorityLevel","guest");this._name=e,t&&(this.accessAuthorityLevel=t),this._parent=r}withFiles(e){return this.files=[...e],this}withChildrenFolder(e){return this.children=e,this}withChildFolder(e){return this.children||(this.children=[]),e.parent=this,this.children.push(e),this}get fullPathName(){const e=[];let t=this;for(;t;)e.unshift(t.name),t=t.parent;return e.join("/")}get name(){return this._name}set name(e){this._name=e}get parent(){return this._parent}set parent(e){this._parent=e}get children(){return this._children}set children(e){var t;e&&(this._children=[...e],(t=this._children)==null||t.forEach(r=>r.parent=this))}get files(){return this._files}set files(e){this._files=e}get accessAuthorityLevel(){return this._accessAuthorityLevel}set accessAuthorityLevel(e){this._accessAuthorityLevel=e}}class c{constructor(e,t,r,s){n(this,"_name","computer");n(this,"_addressIp","0.0.0.0");n(this,"_mainFolder",new a("home"));n(this,"_authority","admin");n(this,"_password","");n(this,"_computersLinked",[]);this.addressIp=e,this.name=t,r&&(this.password=r),s&&(this.authority=s)}withMainFolder(e){return this.mainFolder=e,this}withComputersLinked(e){return this.computersLinked=e,this}withComputerLinked(e){return this._computersLinked.find(t=>t.addressIp===e.addressIp&&t.name===e.name)||(this._computersLinked.push(e),e.computersLinked.find(t=>t.addressIp===this.addressIp&&t.name===this.name)||e._computersLinked.push(this)),this}get name(){return this._name}set name(e){this._name=e}get addressIp(){return this._addressIp}set addressIp(e){if(!/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e))throw new Error("Invalid IP address format");this._addressIp=e}get mainFolder(){return this._mainFolder}set mainFolder(e){this._mainFolder=e}get authority(){return this._authority}set authority(e){this._authority=e}get computersLinked(){return this._computersLinked}set computersLinked(e){e.forEach(t=>{t.computersLinked.find(r=>r.addressIp===t.addressIp&&r.name===t.name)||t.computersLinked.push(this)}),this._computersLinked=[...e]}get password(){return this._password}set password(e){this._password=e}}class h{constructor(e,t,r){n(this,"_name","name.txt");n(this,"_content","");n(this,"_accessAuthorityLevel","guest");this.name=e,this.content=t,r&&(this.accessAuthorityLevel=r)}get name(){return this._name}set name(e){this._name=e}get content(){return this._content}set content(e){this._content=e}get accessAuthorityLevel(){return this._accessAuthorityLevel}set accessAuthorityLevel(e){this._accessAuthorityLevel=e}}const m=512;class f{async openDB(){return new Promise((e,t)=>{const r=indexedDB.open("HacknetProtoDB",1);r.onupgradeneeded=()=>{const s=r.result;s.objectStoreNames.contains("kv")||s.createObjectStore("kv")},r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})}async put(e,t){const r=await this.openDB();return new Promise((s,i)=>{const o=r.transaction("kv","readwrite");o.objectStore("kv").put(t,e),o.oncomplete=()=>s(),o.onerror=()=>i(o.error)})}async get(e){const t=await this.openDB();return new Promise((r,s)=>{const o=t.transaction("kv","readonly").objectStore("kv").get(e);o.onsuccess=()=>r(o.result??null),o.onerror=()=>s(o.error)})}async delete(e){const t=await this.openDB();return new Promise((r,s)=>{const i=t.transaction("kv","readwrite");i.objectStore("kv").delete(e),i.oncomplete=()=>r(),i.onerror=()=>s(i.error)})}}class w{constructor(){n(this,"ownerComputer");n(this,"currentComputer");n(this,"currentFolder");this.ownerComputer=new c("192.168.0.42","wax","wax").withMainFolder(new a("main").withFiles([new h("f1admin.txt","le contenu du fichier admin","admin"),new h("f1user.txt","le contenu du fichier user","user"),new h("f1guest.txt","le contenu du fichier guest","guest")]).withChildrenFolder([new a("intro").withFiles([new h("readme.txt","un nouveau contenu"),new h("secret.txt","code Bob => bob","admin")]),new a("folderAdmin","admin"),new a("folderUser","user"),new a("folderGuest","guest")])).withComputersLinked([new c("192.168.2.1","Bob","bob"),new c("192.168.0.254","Fry"),new c("192.168.14.9","Mey"),new c("193.169.1.11","Dan")]),this.currentComputer=this.ownerComputer,this.currentFolder=this.currentComputer.mainFolder}getOwnerComputer(){return this.ownerComputer}setOwnerComputer(e){this.ownerComputer=e}getCurrentComputer(){return this.currentComputer}setCurrentComputer(e){this.currentComputer=e,this.currentFolder=this.currentComputer.mainFolder}getCurrentFolder(){return this.currentFolder}setCurrentFolder(e){this.currentFolder=e}}class y{constructor(){n(this,"memory");this.memory={total:m,used:0}}getMemory(){return this.memory}setMemory(e){this.memory=e}allocate(e){return this.memory.used+e>this.memory.total?!1:(this.memory.used+=e,!0)}free(e){this.memory.used=Math.max(0,this.memory.used-e)}reset(){this.memory={total:m,used:0}}}class g{constructor(){n(this,"output");n(this,"cwdEl");n(this,"memUsedEl");n(this,"memTotEl");n(this,"connBadge");this.output=document.getElementById("output"),this.cwdEl=document.getElementById("cwd"),this.memUsedEl=document.getElementById("memUsed"),this.memTotEl=document.getElementById("memTot"),this.connBadge=document.getElementById("connBadge")}writeLine(e,t){const r=document.createElement("div");r.className="line"+(t?" "+t:""),r.textContent=e,this.output.appendChild(r),this.output.scrollTop=this.output.scrollHeight}writePromptLine(e){const t=document.createElement("div");t.className="line",t.innerHTML=`<span class="prompt">> </span>${this.escapeHtml(e)}`,this.output.appendChild(t),this.output.scrollTop=this.output.scrollHeight}clearOutput(){this.output.innerHTML=""}updateMemoryUI(e){this.memUsedEl.textContent=String(e.used),this.memTotEl.textContent=String(e.total)}updatePrompt(e,t){this.cwdEl.textContent=e+(t?"#":"$")}updateConnectionBadge(e){this.connBadge.textContent=e?"connected":"offline"}escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}}class C{constructor(){n(this,"isConnected",!1)}isCurrentlyConnected(){return this.isConnected}}class L{constructor(){n(this,"db");n(this,"fs");n(this,"memory");n(this,"ui");n(this,"network");n(this,"form");n(this,"cmdInput");this.db=new f,this.fs=new w,this.memory=new y,this.ui=new g,this.network=new C,this.form=document.getElementById("form"),this.cmdInput=document.getElementById("cmd"),this.setupEventListeners()}setupEventListeners(){this.form.addEventListener("submit",async e=>{e.preventDefault();const t=this.cmdInput.value.trim();if(!t)return;this.ui.writePromptLine(t),this.cmdInput.value="";const r=t.split(/\s+/),s=r[0],i=r.slice(1);await this.executeCommand(s,i)}),this.cmdInput.addEventListener("keydown",e=>{if(e.key==="Tab"){e.preventDefault();const t=Object.keys(this.getCommands()),r=this.cmdInput.value,s=t.find(i=>i.startsWith(r));s&&(this.cmdInput.value=s+" ")}})}async executeCommand(e,t){const s=this.getCommands()[e];if(!s){this.ui.writeLine(`${e}: commande inconnue. Tape 'help'.`);return}try{await s(t)}catch(i){console.error(i),this.ui.writeLine(`Erreur: ${(i==null?void 0:i.message)??String(i)}`)}}getCommands(){return{changeAuth:async e=>{const t=e[0];if(t==="admin"||t==="user"||t==="guest"){this.fs.getCurrentComputer().authority=t,this.ui.updatePrompt(this.getPromptToUpdate(),this.network.isCurrentlyConnected());return}this.ui.writeLine("Usage: changeAuth <admin> or <user> or <guest>")},help:async()=>{this.ui.writeLine("Commandes: help, ls, cat, pwd, cd, echo, scan, connect, run, mem, clear, whoami, save, load, reset"),this.ui.writeLine("Ex: ls, cat readme.txt, cd /home, scan, connect <1.2.0.7> <name> <?password>, run tracer, save/load fs (IndexedDB)")},ls:async()=>{const e=this.fs.getCurrentFolder(),t=[];e.files&&t.push(...e.files.filter(r=>d(this.fs.getCurrentComputer().authority,r.accessAuthorityLevel)).map(r=>r.name)),e.children&&t.push(...e.children.filter(r=>d(this.fs.getCurrentComputer().authority,r.accessAuthorityLevel)).map(r=>r.name)),this.ui.writeLine(t.join("  ")||"")},pwd:async()=>this.ui.writeLine(this.fs.getCurrentFolder().fullPathName),cd:async e=>{var i;const t=e[0];if(!t)return this.ui.writeLine("Usage: cd <folder> or ../");const r=this.fs.getCurrentFolder();if(t==="../"){if(r.parent){this.fs.setCurrentFolder(r.parent),this.ui.writeLine("currentFolder : "+r.parent.name),this.ui.updatePrompt(this.getPromptToUpdate(),this.network.isCurrentlyConnected());return}this.ui.writeLine("error : no parent folder.");return}const s=(i=r.children)==null?void 0:i.find(o=>o.name===t);if(s&&d(this.fs.getCurrentComputer().authority,s.accessAuthorityLevel)){this.fs.setCurrentFolder(s),this.ui.writeLine("currentFolder : "+s.name),this.ui.updatePrompt(this.getPromptToUpdate(),this.network.isCurrentlyConnected());return}this.ui.writeLine('error : folder does not exist with name "'+t+'"')},cat:async e=>{var s;const t=e[0];if(!t)return this.ui.writeLine("Usage: cat <file>");const r=this.fs.getCurrentFolder();if(r.files&&r.files.length>0){const i=(s=r.files)==null?void 0:s.find(o=>o.name===t);if(i&&d(this.fs.getCurrentComputer().authority,i.accessAuthorityLevel)){this.ui.writeLine(i.content);return}}this.ui.writeLine('error : file does not exist with name "'+t+'"')},echo:async e=>this.ui.writeLine(e.join(" ")),whoami:async()=>this.ui.writeLine("guest"),clear:async()=>{this.ui.clearOutput(),this.init()},mem:async()=>{const e=this.memory.getMemory();this.ui.writeLine(`Memory: ${e.used}/${e.total} Mo used`)},scan:async()=>{this.ui.writeLine("Scanning network...");const e=this.fs.getCurrentComputer().computersLinked;e.length===0&&(await this.delay(500),this.ui.writeLine("none"));for(const t of e)await this.delay(Math.random()*500+250),this.ui.writeLine(`${t.addressIp}	${t.name}`);this.ui.writeLine("Scanning network completed")},connect:async e=>{const t=e[0],r=e[1],s=e[2]?e[2]:"";if(!t||!r)return this.ui.writeLine("Usage: connect <ip> <name> <?password>");this.ui.writeLine(`try to connect to ${e} ...`),await this.delay(500);const i=this.fs.getCurrentComputer().computersLinked.find(o=>o.addressIp===t&&o.name===r&&(o.password?o.password===s:!0));if(!i){this.ui.writeLine(`connexion to ${e} failed, please check ip and name`);return}this.fs.setCurrentComputer(i),this.fs.getCurrentComputer().authority="guest",this.ui.updatePrompt(this.getPromptToUpdate(),!0),this.ui.updateConnectionBadge(!0),this.ui.writeLine(`connexion succeed, you are now connected to ${this.fs.getCurrentComputer().addressIp} ${this.fs.getCurrentComputer().name} => ${this.fs.getCurrentFolder().name}`)},disconnect:async()=>{this.ui.writeLine("disconnecting..."),await this.delay(Math.random()*1e3+500),this.fs.setCurrentComputer(this.fs.getOwnerComputer()),this.fs.getCurrentComputer().authority="admin",this.ui.updatePrompt(this.getPromptToUpdate(),!0),this.ui.updateConnectionBadge(!1),this.ui.writeLine(`disconnect succeed, you are now back to ${this.fs.getCurrentComputer().addressIp} ${this.fs.getCurrentComputer().name} => ${this.fs.getCurrentFolder().name}`)},run:async e=>{const t=e[0]??"ping",r=t==="tracer"?256:128;if(!this.memory.allocate(r))return this.ui.writeLine(`run: mémoire insuffisante pour ${t} (besoin ${r} Mo)`);this.ui.writeLine(`Lancement de ${t}... (consomme ${r} Mo)`),this.ui.updateMemoryUI(this.memory.getMemory()),await this.delay(1500+Math.random()*2500),this.ui.writeLine(`${t}: terminé.`),this.memory.free(r),this.ui.updateMemoryUI(this.memory.getMemory())},save:async()=>{this.ui.writeLine("work in progress...")},load:async()=>{this.ui.writeLine("work in progress...")},reset:async()=>{this.memory.reset(),this.ui.updateMemoryUI(this.memory.getMemory()),await this.db.delete("fs"),await this.db.delete("memory"),this.ui.writeLine("Reset: FS remis par défaut et IndexedDB nettoyée.")}}}delay(e){return new Promise(t=>setTimeout(t,e))}async init(){this.ui.writeLine("Hacknet-like terminal prototype (Vanilla TS)"),this.ui.writeLine("Tape 'help' pour commencer."),this.ui.updateMemoryUI(this.memory.getMemory()),this.ui.updatePrompt(this.getPromptToUpdate(),this.network.isCurrentlyConnected()),await this.db.get("fs")&&this.ui.writeLine("load from db.get fs => work in progress...")}getPromptToUpdate(){return this.fs.getCurrentComputer().addressIp+" "+this.fs.getCurrentComputer().name+`[${this.fs.getCurrentComputer().authority.toUpperCase()}] => `+this.fs.getCurrentFolder().fullPathName}}const _=new L;_.init();
